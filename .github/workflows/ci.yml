name: ci

on:
  workflow_dispatch:
  push:
    branches-ignore:
      - "preview/**"
    paths-ignore:
      # - .github
      # - .scripts
      # - .charts
      - kustomize
      - LICENSE
      - README.md
      - build.sh
      - build.ps1
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  versioning:
    uses: f2calv/gha-workflows/.github/workflows/gha-release-versioning.yml@f2calv/2024-04-additions
    with:
      tag-prefix: ''
      tag-and-release: false

  app:
    uses: f2calv/gha-workflows/.github/workflows/app-build-dotnet.yml@f2calv/2024-04-additions
    needs: versioning
    with:
      fullSemVer: ${{ needs.versioning.outputs.fullSemVer }}

  image:
    uses: f2calv/gha-workflows/.github/workflows/container-image-build.yml@f2calv/2024-04-additions
    needs: [versioning, app]
    with:
      tag: ${{ needs.versioning.outputs.semVer }}

  chart:
    uses: f2calv/gha-workflows/.github/workflows/helm-chart-build.yml@f2calv/2024-04-additions
    needs: [versioning, app, image]
    if: github.ref == 'refs/heads/main'
    with:
      semVer: ${{ needs.versioning.outputs.semVer }}

  release:
    needs: [versioning, app, image, chart]
    if: github.ref == 'refs/heads/main'
    uses: f2calv/gha-workflows/.github/workflows/gha-release-versioning.yml@f2calv/2024-04-additions
    permissions:
      contents: write
    with:
      semVer: ${{ needs.versioning.outputs.semVer }}
      tag-prefix: ''
      move-major-tag: false